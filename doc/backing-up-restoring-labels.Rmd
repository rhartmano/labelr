---
title: "Backing up and Restoring Labels"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Backing up and Restoring Labels}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "### >"
)
```
## Overview
Certain R functions and Base R operations may destroy data.frame attributes, 
including those produced by labelr. For this reason, and for other applications
where you may wish to capture a point-in-time "snapshot" of a data.frame's 
labels attributes, labelr provides functions for saving that meta-data and
then (re-)assigning it to a data.frame on-demand, as needed.

## Our Data
First, let's load labelr.
```{r}
library(labelr)
```

Now, let's work with the Motor Trend cars (mtcars) data.frame included with the
Base R distribution. We'll assign it to a new data.frame we call mt2.

```{r}
mt2 <- mtcars
```

## FRAME Label
Let's add a "frame label," which describes the data.frame overall.

```{r}
mt2 <- add_frame_lab(mt2, frame.lab = "Data extracted from the 1974 Motor
Trend US magazine, comprising fuel consumption and 10 aspects of automobile
design and performance for 32 automobiles (1973–74 models). Source: Henderson
and Velleman (1981), Building multiple regression models interactively.
 Biometrics, 37, 391–411.")
```

## NAME Labels
Now, let's assign variable "name labels" to mt2.

```{r}
mt2 <- add_name_labs(mt2,
  name.labs = c(
    "mpg" = "Miles/(US) gallon",
    "cyl" = "Number of cylinders",
    "disp" = "Displacement (cu.in.)",
    "hp" = "Gross horsepower",
    "drat" = "Rear axle ratio",
    "wt" = "Weight (1000 lbs)",
    "qsec" = "1/4 mile time",
    "vs" = "Engine (0 = V-shaped, 1 = straight)",
    "am" = "Transmission (0 = automatic, 1 = manual)",
    "gear" = "Number of forward gears",
    "carb" = "Number of carburetors"
  )
)
```

## ONE-TO-ONE VALUE Labels
Now, we'll assign value one-to-one value labels to vars "am", "carb", and "cyl".

```{r}
mt2 <- add_val_labs(
  data = mt2,
  vars = "am",
  vals = c(0, 1),
  labs = c("automatic", "manual")
)

mt2 <- add_val_labs(
  data = mt2,
  vars = "carb",
  vals = c(1, 2, 3, 4, 6, 8),
  labs = c(
    "1-carb", "2-carbs",
    "3-carbs", "4-carbs",
    "6-carbs", "8-carbs"
  )
)

# var arg can be unquoted if using add_val1()
# note that this is not add_val_labs(); add_val1() has "var" arg instead of "vars
mt2 <- add_val1(
  data = mt2,
  var = cyl, # note, "var," not "vars" arg
  vals = c(4, 6, 8),
  labs = c(
    "four-cyl",
    "six-cyl",
    "eight-cyl"
  )
)
```

### Add MANY-TO-ONE VALUE Labels
Apply "m1" ("many to one") value labels to the "gear" variable.

```{r}
mt2 <- add_m1_lab(
  data = mt2,
  vars = "gear",
  vals = 3,
  lab = "3"
)

mt2 <- add_m1_lab(
  data = mt2,
  vars = "gear",
  vals = c(4, 5),
  lab = "4+"
)
```

## NUMERICAL RANGE Labels
We can label ranges of numerical values using `add_quant_labs()` or `add_quant1()`.
Let's add such labels for variables "mpg" and "disp".

```{r}
mt2 <- add_quant_labs(
  data = mt2,
  vars = "disp",
  qtiles = 3
) # we'll label "disp" values using three quantiles

# get "pretty" value thresholds for "mpg"
mpg_bins <- pretty(c(min(mt2$mpg), max(mt2$mpg)))
mpg_bins

mt2 <- add_quant_labs(
  data = mt2,
  vars = "mpg",
  vals = mpg_bins
) # assign labels using our "pretty" thresholds
```

Let's show that we now have our various labels -- name and value -- in place.

```{r}
get_frame_lab(mt2)

get_name_labs(mt2)

get_val_labs(mt2)
```

Note that, for numerical range-labeled variables like "disp" and "mpg, the values
displayed by `get_val_labs()` are the maximum values observed within that range
label bin -- or the percentile values that defined those bins, if numerical 
ranges were established with the qtiles argument of `add_quant_labs()` (or 
`add_quant1()`).

Another way to show our labels all at once

```{r}
get_all_lab_atts(mt2)
```

## Backing up Label Information with `get_all_lab_atts()`
First, let's use this same function to back up our labels.

```{r}
zlab.mt2 <- get_all_lab_atts(mt2)
```

Now, let's remove label attributes from mt2 and show that we have succeeded.
```{r}
mt2 <- strip_labs(mt2)
```

This is overkill, but to familiarize you further with the functions:
```{r}
get_all_lab_atts(mt2)

get_val_labs(mt2)

get_name_labs(mt2)

get_frame_lab(mt2)
```
The labels are gone.

## Restoring Labels to a Data Frame with `add_lab_atts()`
Now, let's restore the label information to mt2

```{r}
mt2 <- add_lab_atts(mt2, zlab.mt2)

get_all_lab_atts(mt2)

get_val_labs(mt2)

get_name_labs(mt2)

get_frame_lab(mt2)
```

The labels are BACK.

Of course, we could've just re-run our script (or re-played our R history),
but explicitly backing up our labelr attributes can save us some hassle.

## When Base R Attacks - Some Ways to Inadvertently Lose Your Labels
Here are a couple Base R operations that will strip labels from our data. 
That's not what we want.

```{r}
mtgone <- subset(mt2, am == 0 & gear <= 5)

mtlater <- mt2[, c("am", "gear", "cyl")]

sapply(list(mtgone, mtlater), get_all_lab_atts)
```

They're gone.

Let's restore them.

```{r}
mtback <- add_lab_atts(mtgone, zlab.mt2)
mtnotsofast <- add_lab_atts(mtlater, zlab.mt2)

head(use_val_labs(mtback), 3)
head(use_val_labs(mtnotsofast), 3)
```

They're back!
